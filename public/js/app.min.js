function doLogin(){var e=$("#login2"),t=e.find("#txt-email").val(),a=e.find("#txt-password").val(),n=$("#chck-rememberme").attr("checked");progressStart("Loggin in...","Log-in"),$.ajax({url:rooturl+"/events/login",data:{email:t,password:a},type:"POST"}).done(function(e){progressStop(),console.log("login result: "+JSON.stringify(e)),"true"==e.loggedin?(toast("login successfull"),"checked"==n?(setCookie("email",t,cookieDays),setCookie("psw",a,cookieDays)):(deleteCookie("email"),deleteCookie("psw")),$("#index #accountPanel #useremail").html(t),$.mobile.changePage("#index")):$("#login2 #dlg-invalid-credentials").popup("open")}).fail(function(){progressStop(),toast("Error getting elibrary documents","long")})}function showLoginPage(){var e=getCookie("email"),t=getCookie("psw");e&&t?($("#login2 #txt-email").val(e),$("#login2 #txt-password").val(t)):($("#login2 #txt-email").val(""),$("#login2 #txt-password").val("")),$.mobile.changePage("#login2")}function doLogout(){$.mobile.changePage("#login")}function gotoReachMe(){$.mobile.changePage("#reachme")}function doSignup(){var e=$("#signup"),t=e.find("#txt-first-name").val(),a=e.find("#txt-last-name").val(),n=e.find("#txt-email").val(),o=e.find("#txt-password").val(),i=e.find("#txt-password-confirm").val(),r=!1,l="";if(""==$.trim(n)&&(r=!0,l+="email not specified\n"),""==$.trim(o)&&(r=!0,l+="password not specified\n"),""==$.trim(i)&&(r=!0,l+="confirm password not specified\n"),r)return void alerta("ERROR\n\n"+l);var d={firstname:t,lastname:a,email:n,password:o,url:rooturl};$.ajax({url:rooturl+"/events/signupuser",data:d,type:"POST"}).done(function(e){alert(JSON.stringify(e)),$.mobile.changePage("#dlg-sign-up-sent",{role:"dialog"})}).fail(function(){toast("Error getting elibrary documents","long")})}function initPageIndex(){$.ajax({url:rooturl+"/events/listusers",type:"GET"}).done(function(e){if(e.rows){var t=e.rows;colog("Found "+t.length+" users");for(var a=0;a<t.length;a++){var n=t[a].doc;users.push(n)}}else colog("No rows found")}).fail(function(){toast("Error getting elibrary documents","long")})}function showCalendar(){setCalendar(1),$.mobile.changePage("#page_calendar")}function gotoIndex(){$.mobile.changePage("#index")}function gotoElib(){refreshElibrary(),$("#menuPanel").panel("close"),$.mobile.changePage("#page_elibrary")}function refreshElibrary(){docsArray=[],$.ajax({url:rooturl+"/events/listelibrary",type:"GET"}).done(function(e){colog("list result: "+JSON.stringify(e));var t=e.rows;$(t).each(function(e){var a=t[e];docsArray.push(a.doc)}),colog("Found "+t.length+" elibrary documents"),colog("docsArray lenght: "+docsArray.length);var a=new EJS({url:tplurl+"tpl/elibrary.ejs"}).render(docsArray);$("#page_elibrary #ulelib").empty().append(a),$("#page_elibrary #ulelib").find("li").on("taphold",function(){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1],a={id:e,rev:t};gConfirm("Confirm delete of the document ?","Confirm delete",function(){progressStart("Deleting document"),$.ajax({url:rooturl+"/events/deletedocument",data:a,type:"POST"}).done(function(){progressStop(),refreshElibrary()})},function(){})})})}function gotoCalendar(){$.mobile.changePage("#page_calendar"),$("#menuPanel").panel("close")}function initPageCalendar(){$("#page_calendar #mcolor").css("background",meetingcolor).css("color","white"),$("#page_calendar #ecolor").css("background",eventcolor).css("color","white"),colog("pageinit calendar");{var e=new Date;e.getDate(),e.getMonth(),e.getFullYear()}eventsArray=[],$.ajax({url:rooturl+"/events/listcalendarevents",type:"GET"}).done(function(e){if(e.rows){var t=e.rows;colog("Found "+t.length+" calendar events");for(var a=-1,n=0;n<t.length;n++){var o=t[n].doc;a++;{var i=moment(o.start,"YYYYMMDDHHmm"),r=moment(o.end,"YYYYMMDDHHmm");new Date}colog(i+"-"+r);var l=!1,d="meeting",c=meetingcolor;o.eventtype&&(d=o.eventtype),"event"==d&&(c=eventcolor),o.allday&&"true"==o.allday&&(l=!0);var s={id:o._id,rev:o._rev,title:o.summary,summary:o.summary,begin:i.toDate(),start:i.toDate(),end:r.toDate(),allDay:l,eventtype:d,color:c,customer:o.customer};eventsArray.push(s)}sortEvents(),renderCalendar(),setCalendarView("list")}}).fail(function(){toast("Error getting events list","long")})}function sortEvents(){eventsArray.sort(function(e,t){var a=e.start,n=t.start;return a>n?1:n>a?-1:0})}function delEvent(e){deletingEvent=!0,colog("deleteEvent "+e.id+" rev "+e.rev),progressStart("Deleting event..."),$.ajax({url:rooturl+"/events/deletecalendarevent",type:"POST",data:e}).done(function(){deletingEvent=!1}).fail(function(){toast("Error deleting","long")})}function setCalendarView(e){return colog("setcalendarview "+e),aspectRatio=.6,"month"==e&&(aspectRatio=1.2),$("#calwrap").show(),$("#eventlist").hide(),"list"==e?($("#calwrap").hide(),$("#eventlist").show(),void refetchCal()):($("#calendar").fullCalendar("render"),currentview=e,$("#calendar").fullCalendar("changeView",e),$("#calendar").fullCalendar("option","aspectRatio",aspectRatio),$("#calPanel").panel("close"),void rebindCal())}function viewEvent(e){var t=$(e).attr("id").split("_")[0],a=new EJS({url:tplurl+"tpl/eventview.ejs"}).render(getEventById(t));$("#eventview #content").empty().append(a),$.mobile.changePage("#eventview",{srole:"dialog"})}function uploadDocument(){$("#page_upload #titolo").val(""),$("#page_upload #fileattach").val(""),$.mobile.changePage("#page_upload",{srole:"dialog"})}function goUploadDoc(){$("#preview").html(""),progressStart("Uploading document"),$("#imageform").attr("action",rooturl+"/upload"),$("#imageform").ajaxForm({target:"#preview",success:function(){progressStop(),toast("Uploaded"),gotoElib()}}).submit()}function viewDocument(e){var t=$(e).attr("id").split("_")[0],a=getDocById(t);colog("doc: "+JSON.stringify(a));var n=a.path.replace("public","").substring(1);n=n.replace(/\\/g,"/"),$("#page_viewdocument #viewdoc #imgdoc").attr("src",rooturl+"/"+n);var o="https://docs.google.com/viewer?url=";o="",$("#page_viewdocument #viewdoc #filelink").off("tap"),$("#page_viewdocument #viewdoc #filelink").on("tap",function(){downloadElibDoc(rooturl+"/"+n)}),$.mobile.changePage("#page_viewdocument",{srole:"dialog"})}function downloadElibDoc(e){alert(e);var t=new FileTransfer,a=encodeURI(e);t.download(a,"",function(e){console.log("download complete: "+e.fullPath),toast("download completed into "+e.fullPath)},function(e){console.log("download error source "+e.source),console.log("download error target "+e.target),console.log("upload error code"+e.code),toast("download error: "+e.code)})}function renderCalendar(){colog("renderCalendar "+eventsArray.length+" - "+calcreated),$("#page_calendar #calendar").fullCalendar("destroy"),$("#page_calendar #calendar").empty(),$("#page_calendar #calendar").fullCalendar({header:{left:"prev",center:"title",right:"next"},defaultDate:currentdate,defaultView:currentview,editable:!1,events:eventsArray,eventRender:function(e,t){$(t).css("border","2px solid black"),$(t).addClass("evento"),$(t).append("<input type=hidden class=evid value='"+e.id+"' />"),$(t).append("<input type=hidden class=evrev value='"+e.rev+"' />")},gotoDate:currentdate,handleWindowResize:!1,aspectRatio:aspectRatio,windowResize:function(){colog("The calendar has adjusted to a window resize"),$("#page_calendar #calendar").fullCalendar("option","aspectRatio",.6)},loading:function(e){e?$("#page_calendar #calendar").css({visibility:"hidden"}):($("#page_calendar #calendar").css({visibility:"visible"}),colog("calendar loaded"),alert("calendar loaded"),setCalendarView(calendarview))},theme:!1,firstDay:1,axisFormat:"HH:mm",scrollTime:"08:00:00",weekends:!1,dayClick:function(e,t,a,n){colog("dayclick"),currentdate=e;var o=moment(e).format("DD/MM/YYYY");alert("day click "+o),colog("dayClick - "+e+", allDay:"+t+" - "+n.title),$("#eventDialog").find("h3").html("Add event"),$("#eventDialog").find("#currdate").val(o),$("#eventDialog").find("#txtTitle").val(""),$("#eventDialog").find("#txtDescr").val(""),$("#eventDialog").find("#allday").attr("checked",!1),$("#eventDialog").find("#savemode").val("add"),$("#eventDialog").find("#savebutton").html("Add event"),$("#eventDialog").find("#saveid").val(""),$("#eventDialog").find("#saverev").val(""),populatecustomers();var i=moment(e).format("DD/MM/YYYY HH:MM"),r=i;$("#eventDialog  #startdate").val(i.split(" ")[0]),$("#eventDialog  #starttime").val(i.split(" ")[1]),$("#eventDialog  #enddate").val(r.split(" ")[0]),$("#eventDialog  #endtime").val(r.split(" ")[1]),$.mobile.changePage("#eventDialog")}}),calcreated=!0,rebindCal()}function populatecustomers(){$("#eventDialog").find("#customers").empty();for(var e="",t=0;t<users.length;t++)for(var a=users[t].customers,n=a.split(","),o=0;o<n.length;o++){var i=$.trim(n[o]);-1==e.indexOf(i)&&(""!=$.trim(e)&&(e+=","),e+=i)}for(var n=e.split(","),t=0;t<n.length;t++){var r=n[t];$("#eventDialog").find("#customers").append("<option value='"+r+"'>"+r+"</option>")}}function editEvent(e){var t=getEventById(e);$("#eventDialog").find("h3").html("Update event"),$("#eventDialog").find("#currdate").val(t.start),$("#eventDialog").find("#txtTitle").val(t.title),$("#eventDialog").find("#txtDescr").val(t.descr),$("#eventDialog").find("#savemode").val("edit"),$("#eventDialog").find("#saveid").val(t.id),$("#eventDialog").find("#saverev").val(t.rev),t.allDay?$("#eventDialog").find("#allday").attr("checked",!0):$("#eventDialog").find("#allday").attr("checked",!1),$("#eventDialog").find("#savebutton").html("Save event");var a=(t.start,moment(t.start).format("DD/MM/YYYY HH:mm")),n=a;t.end&&(n=moment(t.end).format("DD/MM/YYYY HH:mm")),$("#eventDialog  #startdate").val(a.split(" ")[0]),$("#eventDialog  #starttime").val(a.split(" ")[1]),$("#eventDialog  #enddate").val(n.split(" ")[0]),$("#eventDialog  #endtime").val(n.split(" ")[1]),populatecustomers(),$("#eventDialog #customers").val(t.customer),$.mobile.changePage("#eventDialog")}function rebindCal(){$(".fc-event").unbind("taphold"),$(".fc-event").unbind("click"),$(".fc-event").bind("taphold",function(){colog("taphold event");var e=$(this);$(this).hasClass("fc-event")||(e=$(this).parent());var t=e.find("input.evid").val(),a=e.find("input.evrev").val();deleteEvent({id:t,rev:a,title:""})}),$(".fc-event").bind("click",function(){console.log("tap event");var e=$(this);$(this).hasClass("fc-event")||(e=$(this).parent());var t=e.find("input.evid").val(),a=(e.find("input.evrev").val(),getEventById(t)),n=new EJS({url:tplurl+"tpl/eventpop.ejs"}).render(a);$("#eventPopup #popcontent").empty().html(n).find("tr td:eq(1)").each(function(){$(this).css("font-weight","bold")}),$("#eventPopup").popup("open",{positionTo:"window",overlayTheme:"a"})})}function getEventById(e){for(var t=null,a=0;a<eventsArray.length;a++){var n=eventsArray[a];n.id==e&&(t=n)}return t}function getDocById(e){for(var t=null,a=0;a<docsArray.length;a++){var n=docsArray[a];colog("doc id: "+n.id+" "),n._id==e&&(t=n)}return t}function deleteEvent(e){var t=e.title,a=e.id;colog("evtitle: "+t),gConfirm("Do you really want to delete the event "+t,"Event delete",function(){colog("ok delete"),progressStart("Deleting event"),$.ajax({url:rooturl+"/events/deletecalendarevent",type:"POST",data:e}).done(function(){progressStop();for(var e=eventsArray.length-1;e--;){var t=eventsArray[e];t.id===a&&(toast("event deleted"),eventsArray.splice(e,1))}sortEvents(),$("#calendar").fullCalendar("refetchEvents"),refetchCal(),rebindCal()})},function(){progressStop(),colog("no delete")})}function getDayEvents(e){var t=e.format("YYYYMMDD");colog(e.format().substring(0,10));var a=$("#calendar").fullCalendar("clientEvents"),n="";a.forEach(function(a){var o=a.start.format("YYYYMMDD"),i=a.start.format("DD/MM/YYYY hh:mm");o==t?(colog(t+" - "+a.title),n+='<li><a class="ui-btn ui-btn-icon-right ui-icon-carat-r" href="#">'+i+" - "+a.title+"</a></li>"):a.start<=e.format()&&a.end>=e.format()&&alert(a.title)}),$("#uldayevents").empty().append(n)}function toZDate(e){var t=e.split("/");return t[2]+"-"+t[1]+"-"+t[0]}function toZTime(e){var t=!1;e.indexOf("PM")>-1&&(t=!0),e=e.replace("AM",""),e=e.replace("PM",""),e=$.trim(e);var a=e.split(":");return t&&(colog("cest PM"),a[0]=parseInt(a[0],10)+12,a[0]>23&&(a[0]="0"+(a[0]-23)),colog(a[0])),a[0]+":"+a[1]+":00"}function saveEvent(){var e=$("#eventDialog"),t=$("#eventDialog").find("#savemode").val(),a=$("#eventDialog").find("#saveid").val(),n=$("#eventDialog").find("#saverev").val(),o=$("[name=radiogroup]:checked").val(),i=$("#eventDialog #customers").val(),r=moment($("#startdate").val()+" "+$("#starttime").val(),"DD/MM/YYYY HH:mm"),l=moment($("#enddate").val()+" "+$("#endtime").val(),"DD/MM/YYYY HH:mm"),d=r.format("YYYYMMDDHHmm"),c=l.format("YYYYMMDDHHmm"),s=e.find("#txtTitle").val(),u=!1;if($("#allday:checked").length>0&&(u=!0),""==$.trim(s))return void alerta("Please input title for event");var g=meetingcolor;"event"==o&&(g=eventcolor);var p={summary:s,begin:d,start:d,end:c,allDay:u,eventtype:o,title:s,color:g,customer:i},v="/events/savecalendarevent";"edit"==t&&(v="/events/updcalendarevent",p.id=a,p.rev=n),progressStart("Adding event"),$.ajax({url:rooturl+v,type:"POST",data:p}).done(function(e){if(p.id=e.id,p.rev=e.rev,colog("save result: "+JSON.stringify(e)),"edit"==t)for(var a=0;a<eventsArray.length;a++){var n=eventsArray[a];if(n.id==p.id){var o=p;o.start=moment(d,"YYYYMMDDHHmm").toDate(),o.end=moment(c,"YYYYMMDDHHmm").toDate(),eventsArray[a]=o}}else{var o=p;o.start=moment(d,"YYYYMMDDHHmm").toDate(),o.end=moment(c,"YYYYMMDDHHmm").toDate(),eventsArray.push(o)}colog("events: "+eventsArray.length),sortEvents(),progressStop(),updatecal=!0,$.mobile.changePage("#page_calendar")}).fail(function(){toast("Error posting","long")})}function setCalendar(e){calendarType=e,initPageCalendar(),$("#page_calendar #menuPanel").panel("close"),$("#page_calendar #calPanel").panel("close")}function exitapp(){app.exit()}function init(){colog("init"),app.initialize(),debugga(navigator.userAgent),isPhone=navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)?!0:!1,isPhone||(colog("not running on smartphone, launching docready"),docready())}function docready(){colog("docready"),$("#eventPopup").popup(),$.event.special.tap.emitTapOnTaphold=!1,FastClick.attach(document.body),colog("fastclick attached"),$("li").bind("mouseover",function(){return!1}),$("[data-role=content]").css("min-height",window.innerHeight);var e=$("[data-role=header]").outerHeight(),t=$("[data-role=panel]").height(),a=t-e;$("[data-role=panel]").css({top:e,"min-height":a}),initPageIndex(),initPageCalendar(),$(".ui-btn input").bind("touchstart",function(){$(this).css("background-color","black")}),calendar=$("#calendar_page #calendar"),$(".ui-btn input").bind("touchend",function(){$(this).css("background-color","white")}),$("#page_elibrary").on("pageinit",function(){$("#page_elibrary #menuPanel").panel()}),$("#page_calendar").on("pageinit",function(){colog("pagecalendar init"),$(".ui-btn input").bind("touchstart",function(){$(this).css("background-color","black")}),$(".ui-btn input").bind("touchend",function(){$(this).css("background-color","white")}),$("#page_calendar #menuPanel").panel(),$("#page_calendar #calPanel").panel()}),$("#page_calendar").on("pageshow",function(){updatecal?($("#calendar").fullCalendar("refetchEvents"),refetchCal(),rebindCal(),updatecal=!1):($("#page_calendar #calendar").fullCalendar("render"),rebindCal())}),$("#page_calendar").on("init",function(){initPageCalendar()})}function refetchCal(){var e=new EJS({url:tplurl+"tpl/eventlist.ejs"}).render(eventsArray);$("ul#ulevlist").empty().append(e)}function refreshSchedeServer(){debugga("refreshSchedaServer"),progressStart("Lettura dati"),app.loadAllSchede(function(e){if(e.error)toast("errore","long");else{var t=$("#liElencoSchede");t.html("");var a='<li data-role="list-divider" role="heading" data-theme="b">'+e.rows.length+" schede</li>";t.append(a),e.rows.sort(function(e,t){if(e.doc.nome&&t.doc.nome){var a=e.doc.nome.toLowerCase(),n=t.doc.nome.toLowerCase();if(a>n)return 1;if(n>a)return-1}return 0}),$("#recnum").html(e.rows.length+" "+bonames);var n=new EJS({url:tplurl+"tpl/tpl01.ejs"}).render(e.rows);t.empty().append(n),t.find("li").on("tap",function(){var e=$(this).find("a").attr("id").split("_")[0];return colog("requesting id "+e),progressStart("Lettura dati"),scheda.loadById(e,function(){progressStop(),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on("tap",function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),!1}),t.find("li").on("taphold",function(){var e=$(this).find("a").attr("id").split("_")[0],t=$(this).find("a").attr("id").split("_")[1];return gConfirm("Confermi l'eliminazione della scheda?","Conferma eliminazione",function(){scheda.remove(e,t),$.mobile.changePage("#elencoSchede")},function(){}),!1}),t.listview("refresh")}progressStop()})}function progressStart(e){isPhone?navigator.notification.activityStart(e,"caricamento..."):$.mobile.loading("show",{text:e,textVisible:!0,theme:"z",html:""})}function progressStop(){isPhone&&navigator.notification.activityStop(),$.mobile.loading("hide")}function refreshSchede(){var e=$("#liElencoSchede");e.html("");var t='<li data-role="list-divider" role="heading" data-theme="b">'+app.storage.length+" schede</li>";e.append(t);for(var a=0;a<app.storage.length;a++){var n=$("<li data-theme='c'><a href='#' data-transition='slide'>"+app.storage.key(a)+"</a></li>");n.on("tap",function(){scheda.load($(this).text()),$("#txtNome").val(scheda.data.nome),$("#txtIndirizzo").val(scheda.data.indirizzo),$("#txtDescrizione").val(scheda.data.descrizione),$("#txtPrezzo").val(scheda.data.prezzo),$("#scanDiv").html(scheda.data.barcode),""!=$.trim(scheda.data.photoURI)?($("#fotoAnteprima").attr("src",scheda.data.photoURI).css({width:"128px",height:"128px"}),$("#fotoAnteprima").on("tap",function(){$("#fullPhoto").attr("src",scheda.data.photoURI).css({width:"400px",height:"700px"}),$.mobile.changePage("#viewPhoto",{role:"dialog"})})):$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Modifica "+boname),$.mobile.changePage("#scheda")}),n.on("taphold",function(){var e=$(this).text();navigator.notification.confirm("Confermi l'eliminazione della scheda?",function(t){1==t&&(scheda.remove(e),$.mobile.changePage("#elencoSchede"))},"Conferma eliminazione","Sì,No")}),e.append(n)}e.listview("refresh")}function alerta(e){isPhone?navigator.notification.alert(e,function(){},"Avviso"):alert(e)}function debugga(e){console.log(e)}function newScheda(){delete scheda.data._id,delete scheda.data._rev,scheda.data.nome="",scheda.data.indirizzo="",scheda.data.descrizione="",scheda.data.prezzo="",scheda.data.coordinate="",scheda.data.photoURI="",scheda.data.barcode="",$("#txtNome").val(""),$("#txtIndirizzo").val(""),$("#txtDescrizione").val(""),$("#txtPrezzo").val(""),$("#scanDiv").html("No code"),$("#fotoAnteprima").attr("src","img/nophoto.jpg").css({width:"128px",height:"128px"}),$("#scheda h3").html("Nuova "+boname),$.mobile.changePage("#scheda")}function toast(e,t){isPhone?window.plugins.toast.show(e,t,"center",function(){},function(){}):console.log("toast: "+e)}function gConfirm(e,t,a,n){isPhone?navigator.notification.confirm(e,function(e){1==e?a():n()},t,"Sì,No"):confirm(e)?a():n()}function colog(e){logactive&&console.log(e)}function getCookie(e){var t=document.cookie,a=t.indexOf(" "+e+"=");if(-1==a&&(a=t.indexOf(e+"=")),-1==a)t=null;else{a=t.indexOf("=",a)+1;var n=t.indexOf(";",a);-1==n&&(n=t.length),t=unescape(t.substring(a,n))}return t}function setCookie(e,t,a){var n=new Date;n.setDate(n.getDate()+a);var o=escape(t)+(null==a?"":"; expires="+n.toUTCString());document.cookie=e+"="+o}function checkCookie(){var e=getCookie("username");null!=e&&""!=e?alert("Welcome again "+e):(e=prompt("Please enter your username:",""),null!=e&&""!=e&&setCookie("username",e,365))}var pictureSource,destinationType,scheda={},rooturl="http://ssodemyapp.mybluemix.net",logactive=!1,isPhone=!1,boname="scheda",bonames="Schede",eventsArray=[],docsArray=[],calendarType=1,currentview="agendaWeek",currentdate=new Date,calcreated=!1,aspectRatio=.6,deletingEvent=!1,meetingcolor="#3333CC",eventcolor="#009933",calendar,updatecal=!1,users=[],calendarview="list",tplurl="",cookieDays=3,app={initialize:function(){colog("app.initialize"),this.bind()},onCameraSuccess:function(e){toast("Photo acquired","long");var t,a,n;for(t=0,n=e.length;n>t;t+=1)a=e[t].fullPath,$("#fotoAnteprima").attr("src",a).css({width:"128px",height:"128px"})},onCameraError:function(e){toast("Error acquiring photo: "+e,"long")},onMenuButton:function(){var e=$.mobile.activePage.attr("id");$("#"+e+" #menuPanel").panel("toggle")},onBackButton:function(){var e=$.mobile.activePage.attr("id"),t=$("#"+e+" #btnBack");t.length>0?$("#"+e+" #btnBack").trigger("click"):$.mobile.back()},online:function(){$("#btnInviaSchede").removeClass("ui-disabled")},offline:function(){$("#btnInviaSchede").addClass("ui-disabled")},isOnline:function(){var e=navigator.connection.type;return toast(e,"short"),e!=Connection.NONE&&e!=Connection.UNKNOWN},bind:function(){colog("bind"),document.addEventListener("deviceready",this.deviceready,!1)},deviceready:function(){colog("deviceready"),colog("deviceready"),document.addEventListener("online",app.online,!1),document.addEventListener("offline",app.offline,!1),document.addEventListener("menubutton",app.onMenuButton,!1),document.addEventListener("backbutton",app.onBackButton,!1),pictureSource=navigator.camera.PictureSourceType,destinationType=navigator.camera.DestinationType,-1!=navigator.userAgent.indexOf("Android")&&($.mobile.defaultPageTransition="none",$.mobile.defaultDialogTransition="none",$.mobile.buttonMarkup.hoverDelay=0),docready(),app.start()},start:function(){},exit:function(){navigator.notification.confirm("Vuoi uscire dall'applicazione?",function(e){1==e&&navigator.app.exitApp()},"Informazione","Sì,No")},storage:window.localStorage,loadAllSchede:function(e){$.ajax({url:rooturl+"/schede",type:"GET"}).done(function(t){e(t)})}};$(document).one("pagebeforecreate",function(e){colog("pageberforecreate ");var t={},a=e.target.id,n=$("#"+a+" #menuPanel").length;if(0==n){var o=new EJS({url:tplurl+"tpl/menupanel.ejs"}).render(t);$.mobile.pageContainer.prepend(o)}$("#menuPanel").panel()});var scheda={send:function(){navigator.notification.confirm("Confermi l'invio delle schede?",scheda.confirmedSend,"Conferma invio","Sì,No")},save:function(e,t,a){if(""!=scheda.data.nome){app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data));var n="addScheda";scheda.data._id&&(n="updScheda"),colog("posting "+JSON.stringify(scheda.data)),$.ajax({url:rooturl+"/schede/"+n,type:"POST",data:scheda.data}).done(function(e){e.error?a():(app.storage.clear(),colog("save result: "+JSON.stringify(e)),t())}).fail(function(){toast("Error posting","long")})}},onPositionSuccess:function(e){scheda.data.coordinate=e.coords,toast(JSON.stringify(scheda.data),"short"),app.storage.setItem(scheda.data.nome,JSON.stringify(scheda.data)),refreshSchedeServer()},onPositionError:function(e){var t="";switch(e.code){case PositionError.PERMISSION_DENIED:t="L'applicazione non è autorizzata all'acquisizione della posizione corrente";break;case PositionError.POSITION_UNAVAILABLE:t="Non è disponibile la rilevazione della posizione corrente";break;case PositionError.TIMEOUT:t="Non è stato possibile rilevare la posizione corrente"}toast(t,"long")},load:function(e){if(""!=e){var t=app.storage.getItem($.trim(e));scheda.data=JSON.parse(t)}},loadById:function(e,t){delete scheda.data._id,delete scheda.data._rev,$.ajax({url:rooturl+"/schede/findById/"+e,type:"GET"}).done(function(a){colog("loadbyid "+e+": "+JSON.stringify(a)),scheda.data=a,t(scheda)})},remove:function(e,t){debugga(e+" "+t),""!=e&&$.ajax({url:rooturl+"/schede/delScheda",type:"POST",data:{id:e,rev:t}}).done(function(){app.storage.clear(),refreshSchedeServer()}).fail(function(){toast("Error posting","long")})},send:function(e,t,a){$.ajax({url:"http://ssodemyapp.mybluemix.net/schede/addScheda",type:"POST",data:e}).done(function(){app.storage.clear(),t()}).fail(a)},data:{nome:"",indirizzo:"",descrizione:"",prezzo:"0,00",coordinate:{},photoURI:"",barcode:""}},deleteCookie=function(e){document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:01 GMT;"};